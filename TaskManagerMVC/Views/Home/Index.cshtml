@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer localizer

@{
    ViewData["Title"] = "Listado tareas";
}
<div class="text-center">
    <h1 class="display-4">@localizer["Mis tareas"]</h1>
    <button type="button" class="btn btn-primary mb-3" onclick="agregarNuevaTareaAlListado()">@localizer["Agregar nueva tarea"]</button>
   
</div>

<div id="contenedor-listado-tareas" class="text-center">
    <div id="reordenable" class="text-start" data-bind="foreach: tareas">
        <div name="tarea" class="border mb-2 p-2" style="cursor: pointer"
             data-bind="click:manejarClickTarea">
            <div data-bind="text: title, hidden: esNuevo" class="fw-bold">
            </div>

            <input type="text" name="title-tarea" class="input-group text-dark" autocomplete="off" 
                data-bind="value:title, visible: esNuevo,
                        attr: {'data-id': id},
                        event: {focusout: manegarFocusOutTituloTarea}" />
        </div>
    </div>
    <div data-bind="visible: cargando" class="spinner-border">
        <span class="visually-hidden">Cargando ...</span>
    </div>

    <div data-bind="visible: noHayTareas">
        No existen tareas para mostrar
    </div>
</div>
<partial name="_ModalEditarTarea"></partial>
@section Scripts{
    <script src="~/js/Utilities.js" asp-append-version="true"></script>
    <script src="~/js/Tareas.js" asp-append-version="true"></script>
    <script src="~/js/Pasos.js" asp-append-version="true"></script>
    <script>
        const urlTareas = "/api/tareas";
        const urlsteps = "/api/steps";
        const modalEditarTarea = document.getElementById('modal-editar-tarea');
        const modalEditarTareaBootstrap = new bootstrap.Modal(modalEditarTarea);
        // const tareaListadoViewModel = {
        //     tareas: ko.observableArray([]),
        //     cargando: ko.observable(true)
        // }
        function tareaListadoViewModelFn() {
            var self = this;
            self.tareas = ko.observableArray([]);
            self.cargando = ko.observable(true);
            self.noHayTareas = ko.pureComputed(function(){
                if(self.cargando()){
                    return false;
                }

                return self.tareas().length === 0;
            })
        }//Ahora podemos colocar el self.noHayTareas

        function TareaElementoListadoViewModel({id, title}){
            var self = this;
            self.id = ko.observable(id);
            self.title = ko.observable(title);
            self.esNuevo = ko.pureComputed(function(){
                return self.id() ==0;
            })
        }

        const tareaEditaVM ={
            id:0,
            title: ko.observable(''),
            description: ko.observable(''),
            steps: ko.observableArray([])
        }

        const tareaListadoViewModel = new tareaListadoViewModelFn();

        function pasoViewModel({id, description, realizado, modoEdicion}){
            var self = this;
            self.id = ko.observable(id || 0);
            self.description = ko.observable(description || '');
            self.realizado = ko.observable(realizado);
            self.modoEdicion = ko.observable(modoEdicion);

            self.esNuevo = ko.pureComputed(function(){
                return self.id() == 0;
            })
        } 

        obtenerTareas();

        ko.applyBindings(tareaListadoViewModel, document.getElementById('contenedor-listado-tareas'));
        ko.applyBindings(tareaEditaVM, document.getElementById('modal-editar-tarea'));
    </script>
}